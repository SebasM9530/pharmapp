<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PharmaChem â€” Asistente de Estudio</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=DM+Mono:wght@300;400;500&family=Crimson+Pro:wght@300;400;600&display=swap" rel="stylesheet">
<style>
  :root{--bg:#07080f;--surface:#0d1020;--surface2:#131628;--border:#1e2545;--accent:#4fc3c3;--accent2:#c9a84c;--accent3:#7c6fd4;--text:#e8eaf6;--text-dim:#8892b0;--danger:#ef5350;--success:#26a69a;--warn:#ff9800}
  *{box-sizing:border-box;margin:0;padding:0}
  body{background:var(--bg);color:var(--text);font-family:'Crimson Pro',serif;font-size:17px;min-height:100vh;overflow-x:hidden}
  .bg-canvas{position:fixed;inset:0;z-index:0;pointer-events:none;overflow:hidden}
  .molecule{position:absolute;opacity:.04;animation:floatMol linear infinite}
  @keyframes floatMol{0%{transform:translateY(110vh) rotate(0deg)}100%{transform:translateY(-20vh) rotate(360deg)}}
  #app{position:relative;z-index:1;min-height:100vh}
  /* HEADER */
  header{padding:1.2rem 2rem;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);background:rgba(7,8,15,.9);backdrop-filter:blur(12px);position:sticky;top:0;z-index:100;flex-wrap:wrap;gap:.75rem}
  .logo{display:flex;align-items:center;gap:.75rem}
  .logo-text{font-family:'Playfair Display',serif;font-size:1.4rem}
  .logo-text span{color:var(--accent)}
  nav{display:flex;gap:.3rem;background:var(--surface);padding:.3rem;border-radius:12px;border:1px solid var(--border);flex-wrap:wrap}
  .nav-btn{padding:.5rem 1rem;border-radius:8px;border:none;background:transparent;color:var(--text-dim);font-family:'DM Mono',monospace;font-size:.76rem;cursor:pointer;transition:all .2s}
  .nav-btn:hover{color:var(--text);background:var(--surface2)}
  .nav-btn.active{background:linear-gradient(135deg,rgba(79,195,195,.2),rgba(124,111,212,.2));color:var(--accent);border:1px solid rgba(79,195,195,.3)}
  .powered-badge{display:inline-flex;align-items:center;gap:.4rem;font-family:'DM Mono',monospace;font-size:.68rem;color:var(--text-dim);background:var(--surface2);border:1px solid var(--border);border-radius:20px;padding:.2rem .7rem}
  .groq-text{background:linear-gradient(90deg,#f55036,#ff8c00);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-weight:700}
  .free-badge{background:rgba(38,166,154,.15);color:var(--success);border:1px solid rgba(38,166,154,.3);border-radius:6px;font-family:'DM Mono',monospace;font-size:.65rem;padding:.15rem .5rem}
  .srv-dot{width:7px;height:7px;border-radius:50%;background:var(--danger);display:inline-block;animation:pulse 2s infinite;margin-right:.4rem}
  .srv-dot.ok{background:var(--success);animation:none}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
  .srv-label{font-family:'DM Mono',monospace;font-size:.68rem;color:var(--text-dim)}
  /* PAGES */
  .page{display:none;padding:2rem;max-width:1100px;margin:0 auto;width:100%;animation:fadeIn .3s ease}
  .page.active{display:block}
  @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
  /* CARD */
  .card{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:1.5rem;position:relative;overflow:hidden;margin-bottom:1rem}
  .card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--accent),var(--accent3));opacity:.6}
  .section-title{font-family:'Playfair Display',serif;font-size:1.5rem;margin-bottom:.2rem}
  .section-sub{font-family:'DM Mono',monospace;font-size:.7rem;color:var(--text-dim);letter-spacing:.1em;text-transform:uppercase;margin-bottom:1.5rem}
  /* BTN */
  .btn{display:inline-flex;align-items:center;gap:.5rem;padding:.65rem 1.4rem;border-radius:10px;border:none;font-family:'DM Mono',monospace;font-size:.78rem;cursor:pointer;transition:all .2s;letter-spacing:.05em;text-transform:uppercase}
  .btn-primary{background:linear-gradient(135deg,var(--accent),#3da8a8);color:#07080f;font-weight:500}
  .btn-primary:hover{transform:translateY(-1px);box-shadow:0 4px 20px rgba(79,195,195,.3)}
  .btn-secondary{background:var(--surface2);color:var(--text);border:1px solid var(--border)}
  .btn-secondary:hover{border-color:var(--accent);color:var(--accent)}
  .btn-gold{background:linear-gradient(135deg,var(--accent2),#b8952e);color:#07080f;font-weight:500}
  .btn-gold:hover{transform:translateY(-1px);box-shadow:0 4px 20px rgba(201,168,76,.3)}
  .btn:disabled{opacity:.4;cursor:not-allowed;transform:none!important}
  /* INPUTS */
  input[type="text"],input[type="number"],select{background:var(--surface2);border:1px solid var(--border);border-radius:10px;color:var(--text);font-family:'Crimson Pro',serif;font-size:1rem;padding:.65rem 1rem;transition:border-color .2s;width:100%;outline:none}
  input:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(79,195,195,.1)}
  select option{background:var(--surface2)}
  label{font-family:'DM Mono',monospace;font-size:.7rem;color:var(--text-dim);display:block;margin-bottom:.4rem;letter-spacing:.05em}
  /* UPLOAD */
  .upload-zone{border:2px dashed var(--border);border-radius:16px;padding:2.5rem;text-align:center;cursor:pointer;transition:all .2s;position:relative}
  .upload-zone:hover,.upload-zone.drag-over{border-color:var(--accent);background:rgba(79,195,195,.04)}
  .upload-zone input{position:absolute;inset:0;opacity:0;cursor:pointer}
  .upload-icon{font-size:2.5rem;margin-bottom:.5rem}
  .upload-zone p{color:var(--text-dim);font-size:.9rem}
  .upload-zone strong{color:var(--accent)}
  .apuntes-list{display:flex;flex-wrap:wrap;gap:.75rem;margin-top:1rem}
  .apunte-tag{display:flex;align-items:center;gap:.5rem;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:.4rem .75rem;font-family:'DM Mono',monospace;font-size:.75rem;color:var(--text-dim)}
  .apunte-tag .rm{background:none;border:none;color:var(--danger);cursor:pointer;font-size:1rem;line-height:1}
  .apunte-thumb{width:36px;height:36px;border-radius:4px;object-fit:cover}
  /* PROGRESS */
  .progress-wrap{margin-top:.5rem;display:none}
  .progress-wrap.show{display:block}
  .progress-bar{height:4px;background:var(--border);border-radius:2px;overflow:hidden}
  .progress-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent3));border-radius:2px;transition:width .3s;width:0%}
  .progress-label{font-family:'DM Mono',monospace;font-size:.7rem;color:var(--text-dim);margin-top:.3rem}
  /* DRUG SEARCH */
  .drug-search-bar{display:flex;gap:.75rem;margin-bottom:1rem}
  .drug-search-bar input{flex:1}
  .drug-history{display:flex;flex-wrap:wrap;gap:.5rem;margin-bottom:1.2rem}
  .drug-pill{padding:.3rem .9rem;border-radius:20px;font-family:'DM Mono',monospace;font-size:.72rem;cursor:pointer;transition:all .15s;border:1px solid var(--border);background:var(--surface2);color:var(--text-dim)}
  .drug-pill:hover{border-color:var(--accent);color:var(--accent)}
  /* FLASHCARDS */
  .flashcards-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(290px,1fr));gap:1rem;margin-top:1rem}
  .flashcard{background:var(--surface);border:1px solid var(--border);border-radius:16px;overflow:hidden;animation:cardAppear .4s ease both;transition:transform .2s,box-shadow .2s}
  .flashcard:hover{transform:translateY(-3px);box-shadow:0 8px 30px rgba(0,0,0,.3)}
  @keyframes cardAppear{from{opacity:0;transform:translateY(16px) scale(.97)}to{opacity:1;transform:none}}
  .fc-header{padding:1rem 1.2rem .75rem;display:flex;align-items:center;gap:.75rem;border-bottom:1px solid var(--border)}
  .fc-icon{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1rem;flex-shrink:0}
  .fc-title{font-family:'Playfair Display',serif;font-size:.9rem;font-weight:700}
  .fc-body{padding:1rem 1.2rem;font-size:.93rem;line-height:1.65;color:var(--text-dim)}
  .fc-body strong{color:var(--text)}
  .badge{display:inline-flex;align-items:center;gap:.3rem;font-family:'DM Mono',monospace;font-size:.65rem;padding:.15rem .5rem;border-radius:20px;margin-top:.5rem}
  .badge-ai{background:rgba(79,195,195,.1);color:var(--accent);border:1px solid rgba(79,195,195,.2)}
  .badge-notes{background:rgba(201,168,76,.1);color:var(--accent2);border:1px solid rgba(201,168,76,.2)}
  /* LOADER */
  .loader{display:none;flex-direction:column;align-items:center;gap:1rem;padding:3rem;text-align:center}
  .loader.active{display:flex}
  .loader-ring{width:48px;height:48px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  .loader p{font-family:'DM Mono',monospace;font-size:.8rem;color:var(--text-dim)}
  /* QUIZ */
  .quiz-setup{display:flex;flex-direction:column;gap:1rem}
  .quiz-row{display:flex;gap:1rem;align-items:flex-end;flex-wrap:wrap}
  .quiz-row>*{flex:1;min-width:140px}
  .question-card{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:1.5rem;margin-bottom:1rem;animation:cardAppear .3s ease both}
  .q-num{font-family:'DM Mono',monospace;font-size:.7rem;color:var(--accent);letter-spacing:.1em;text-transform:uppercase;margin-bottom:.5rem}
  .q-text{font-family:'Crimson Pro',serif;font-size:1.05rem;line-height:1.5;margin-bottom:1rem;color:var(--text)}
  .q-src{font-family:'DM Mono',monospace;font-size:.68rem;color:var(--text-dim);font-style:italic;margin-bottom:.75rem}
  .options{display:flex;flex-direction:column;gap:.5rem}
  .opt{display:flex;align-items:flex-start;gap:.75rem;padding:.7rem 1rem;border-radius:10px;border:1px solid var(--border);cursor:pointer;transition:all .15s;background:var(--surface2)}
  .opt:hover{border-color:var(--accent);background:rgba(79,195,195,.04)}
  .opt.selected{border-color:var(--accent3);background:rgba(124,111,212,.1)}
  .opt.correct{border-color:var(--success)!important;background:rgba(38,166,154,.1)!important}
  .opt.wrong{border-color:var(--danger)!important;background:rgba(239,83,80,.1)!important}
  .opt-letter{width:24px;height:24px;border-radius:6px;background:var(--border);display:flex;align-items:center;justify-content:center;font-family:'DM Mono',monospace;font-size:.7rem;flex-shrink:0;margin-top:.1rem}
  .opt.selected .opt-letter{background:var(--accent3);color:#fff}
  .opt.correct .opt-letter{background:var(--success);color:#fff}
  .opt.wrong .opt-letter{background:var(--danger);color:#fff}
  .opt-text{font-size:.95rem;line-height:1.4}
  .expl{margin-top:.75rem;padding:.75rem 1rem;background:rgba(79,195,195,.05);border-left:3px solid var(--accent);border-radius:0 8px 8px 0;font-size:.88rem;color:var(--text-dim);display:none}
  .expl.show{display:block}
  .quiz-results{text-align:center;padding:2rem;animation:fadeIn .4s ease}
  .score-ring{width:120px;height:120px;border-radius:50%;margin:0 auto 1rem;display:flex;align-items:center;justify-content:center;font-family:'Playfair Display',serif;font-size:2rem;font-weight:700;border:4px solid var(--accent);background:rgba(79,195,195,.05);color:var(--accent)}
  .results-grid{display:flex;gap:1rem;justify-content:center;margin:1.5rem 0;flex-wrap:wrap}
  .result-stat{background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:.75rem 1.5rem;text-align:center}
  .result-stat .num{font-family:'Playfair Display',serif;font-size:1.8rem;color:var(--accent2)}
  .result-stat .lbl{font-family:'DM Mono',monospace;font-size:.65rem;color:var(--text-dim);text-transform:uppercase}
  /* TOAST */
  #toast{position:fixed;bottom:1.5rem;right:1.5rem;background:var(--surface2);border:1px solid var(--accent);border-radius:12px;padding:.75rem 1.2rem;font-family:'DM Mono',monospace;font-size:.8rem;color:var(--accent);z-index:999;transform:translateY(80px);opacity:0;transition:all .3s;max-width:340px;line-height:1.4}
  #toast.show{transform:none;opacity:1}
  #toast.warn{border-color:var(--warn);color:var(--warn)}
  #toast.ok{border-color:var(--success);color:var(--success)}
  ::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
  .empty{text-align:center;padding:3rem;color:var(--text-dim)}
  .empty .emoji{font-size:3rem;margin-bottom:.75rem}
  .empty p{font-size:.9rem}
  .err-box{background:rgba(239,83,80,.06);border:1px solid rgba(239,83,80,.25);border-radius:10px;padding:1rem;font-family:'DM Mono',monospace;font-size:.78rem;color:var(--danger);line-height:1.6;margin-top:.5rem}
  .apuntes-note-box{margin-top:.75rem;padding:.5rem .75rem;background:rgba(201,168,76,.08);border-left:3px solid var(--accent2);border-radius:0 6px 6px 0}
  .apuntes-note-label{font-family:'DM Mono',monospace;font-size:.62rem;color:var(--accent2);margin-bottom:.2rem}
</style>
</head>
<body>
<div class="bg-canvas" id="bgCanvas"></div>
<div id="app">

<header>
  <div class="logo">
    <svg width="36" height="36" viewBox="0 0 36 36" fill="none">
      <circle cx="18" cy="18" r="17" stroke="#4fc3c3" stroke-width="1.5"/>
      <circle cx="18" cy="9" r="3" fill="#4fc3c3"/>
      <circle cx="9" cy="24" r="3" fill="#c9a84c"/>
      <circle cx="27" cy="24" r="3" fill="#7c6fd4"/>
      <line x1="18" y1="12" x2="9" y2="21" stroke="#4fc3c3" stroke-width="1.2"/>
      <line x1="18" y1="12" x2="27" y2="21" stroke="#4fc3c3" stroke-width="1.2"/>
      <line x1="11.5" y1="24" x2="24.5" y2="24" stroke="#4fc3c3" stroke-width="1.2"/>
    </svg>
    <div class="logo-text">Pharma<span>Chem</span></div>
  </div>
  <div style="display:flex;align-items:center;gap:.75rem;flex-wrap:wrap">
    <span><span class="srv-dot" id="srvDot"></span><span class="srv-label" id="srvLbl">Conectando...</span></span>
    <div class="powered-badge">powered by <span class="groq-text">Groq</span>&nbsp;<span class="free-badge">GRATIS</span></div>
    <nav>
      <button class="nav-btn active" onclick="showPage('apuntes',this)">ğŸ“ Apuntes</button>
      <button class="nav-btn" onclick="showPage('flashcards',this)">ğŸƒ Flashcards</button>
      <button class="nav-btn" onclick="showPage('quiz',this)">ğŸ§ª Quiz</button>
      <button class="nav-btn" onclick="showPage('repaso',this);iniciarRepaso()">ğŸ”„ Repaso</button>
    </nav>
  </div>
</header>

<!-- APUNTES -->
<div class="page active" id="page-apuntes">
  <h1 class="section-title">ğŸ“ Mis Apuntes</h1>
  <p class="section-sub">Sube PDFs escaneados, fotos de cuaderno o TXT â€” OCR automÃ¡tico con IA</p>

  <div class="card">
    <div class="upload-zone" id="uploadZone">
      <input type="file" id="fileInput" multiple accept=".pdf,.txt,image/*">
      <div class="upload-icon">ğŸ§¬</div>
      <p><strong>Arrastra archivos aquÃ­</strong> o haz clic para seleccionar</p>
      <p style="margin-top:.3rem;font-size:.82rem">PDF (digital o escaneado con OCR âœ¨) Â· Fotos JPG/PNG Â· TXT</p>
    </div>
    <div class="progress-wrap" id="progressWrap">
      <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
      <div class="progress-label" id="progressLabel">Procesando...</div>
    </div>
    <div class="apuntes-list" id="apuntesList"></div>
  </div>

  <div class="card">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;flex-wrap:wrap;gap:.5rem">
      <h3 style="font-family:'Playfair Display',serif">ğŸ“ Resumen Analizado por Groq</h3>
      <button class="btn btn-secondary" onclick="clearAll()" style="font-size:.7rem;padding:.4rem .9rem">ğŸ—‘ Limpiar todo</button>
    </div>
    <div id="apuntesResumen">
      <div class="empty"><div class="emoji">ğŸ“‚</div><p>Sube tus apuntes â€” Groq los analizarÃ¡ automÃ¡ticamente</p></div>
    </div>
  </div>
</div>

<!-- FLASHCARDS -->
<div class="page" id="page-flashcards">
  <h1 class="section-title">ğŸƒ Flashcards FarmacolÃ³gicas</h1>
  <p class="section-sub">Groq + Llama 3 Â· Conocimiento mÃ©dico + tus apuntes</p>
  <div class="drug-search-bar">
    <input type="text" id="drugInput" placeholder="Ej: Amoxicilina, Metformina, Warfarina..." onkeydown="if(event.key==='Enter')searchDrug()">
    <button class="btn btn-primary" onclick="searchDrug()">ğŸ” Analizar</button>
  </div>
  <div id="drugHistory" class="drug-history"></div>
  <div class="loader" id="flashLoader"><div class="loader-ring"></div><p>Groq analizando medicamento...</p></div>
  <div id="flashcardsContainer"><div class="empty"><div class="emoji">ğŸ”¬</div><p>Escribe un medicamento y presiona "Analizar"</p></div></div>
</div>

<!-- QUIZ -->
<div class="page" id="page-quiz">
  <h1 class="section-title">ğŸ§ª Quiz de FarmacologÃ­a</h1>
  <p class="section-sub">Preguntas estilo MIR / USMLE con referencias cientÃ­ficas reales</p>
  <div class="card">
    <h3 style="font-family:'Playfair Display',serif;margin-bottom:1.2rem">Configurar Quiz</h3>
    <div class="quiz-setup">
      <div>
        <label>Medicamentos (separados por coma)</label>
        <div style="display:flex;gap:.6rem;align-items:center;flex-wrap:wrap">
          <input type="text" id="quizDrugs" placeholder="Ej: Penicilina, Ibuprofeno, Digoxina" style="flex:1;min-width:200px">
          <button id="usarMedicamentosBtn" onclick="usarMedicamentosDelResumen()" style="display:none;white-space:nowrap" class="btn btn-secondary" title="">
            ğŸ“‹ Usar del resumen
          </button>
        </div>
      </div>
      <div class="quiz-row">
        <div><label>NÃºmero de preguntas</label><input type="number" id="quizCount" value="10" min="3" max="20" placeholder="3-20"></div>
        <div><label>Dificultad</label>
          <select id="quizDiff">
            <option value="basica">BÃ¡sica</option>
            <option value="intermedia" selected>Intermedia</option>
            <option value="avanzada">Avanzada (MIR/USMLE)</option>
          </select>
        </div>
        <div><label>Tipo</label>
          <select id="quizType">
            <option value="mixto">Mixto</option>
            <option value="mecanismo">Mecanismo de acciÃ³n</option>
            <option value="clinico">Casos clÃ­nicos</option>
            <option value="interacciones">Interacciones y RAM</option>
          </select>
        </div>
      </div>
      <button class="btn btn-gold" onclick="generateQuiz()" style="align-self:flex-start">ğŸ§¬ Generar Quiz</button>
    </div>
  </div>
  <div class="loader" id="quizLoader"><div class="loader-ring"></div><p>Groq generando preguntas con referencias cientÃ­ficas...</p></div>
  <div id="quizContainer"></div>
</div>

<!-- REPASO -->
<div class="page" id="page-repaso">
  <h1 class="section-title">ğŸ”„ Modo Repaso</h1>
  <p class="section-sub">Repasa tus flashcards una por una Â· Marca lo que sabes</p>
  <div id="repasoContainer">
    <div class="empty">
      <div class="emoji">ğŸƒ</div>
      <p>Primero genera flashcards de un medicamento,<br>luego vuelve aquÃ­ para repasar</p>
      <button class="btn btn-primary" onclick="showPage('flashcards',document.querySelector('[onclick*=flashcards]'))" style="margin-top:1rem">Ir a Flashcards</button>
    </div>
  </div>
</div>

</div><!-- #app -->
<div id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const S = {
  apuntes: JSON.parse(localStorage.getItem('pc_apuntes') || '[]'),
  resumen: localStorage.getItem('pc_resumen') || '',
  history: JSON.parse(localStorage.getItem('pc_history') || '[]'),
  quiz: [], answers: {}, submitted: false,
  extractedDrugs: []
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BACKGROUND
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function(){
  const c = document.getElementById('bgCanvas');
  ['â¬¡','â—ˆ','â¬Ÿ','â—‹','â–³','â—‡'].forEach((s,i) => {
    for(let j=0;j<2;j++){
      const el = document.createElement('div');
      el.className = 'molecule';
      el.textContent = s;
      el.style.cssText = `left:${Math.random()*100}%;font-size:${40+Math.random()*80}px;animation-duration:${20+Math.random()*30}s;animation-delay:-${Math.random()*30}s;color:${['#4fc3c3','#c9a84c','#7c6fd4'][Math.floor(Math.random()*3)]};`;
      c.appendChild(el);
    }
  });
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showPage(id, btn) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('page-' + id).classList.add('active');
  if(btn) btn.classList.add('active');
}

let toastTimer;
function toast(msg, type='normal', dur=4000) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = 'show' + (type==='warn' ? ' warn' : type==='ok' ? ' ok' : '');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.classList.remove('show'), dur);
}

function setProgress(pct, label) {
  const w = document.getElementById('progressWrap');
  const f = document.getElementById('progressFill');
  const l = document.getElementById('progressLabel');
  if(pct === null) { w.classList.remove('show'); return; }
  w.classList.add('show');
  f.style.width = pct + '%';
  if(label) l.textContent = label;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SERVER CHECK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function checkServer() {
  try {
    const r = await fetch('/api/health');
    // Si el server responde (aunque sea error de json) estÃ¡ online
    document.getElementById('srvDot').className = 'srv-dot ok';
    document.getElementById('srvLbl').textContent = 'Servidor online';
  } catch(e) {
    document.getElementById('srvDot').className = 'srv-dot';
    document.getElementById('srvLbl').textContent = 'Servidor offline â€” ejecuta npm start';
    toast('âš  Servidor no encontrado. Ejecuta: npm start', 'warn', 10000);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// APUNTES â€” UPLOAD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const uz = document.getElementById('uploadZone');
const fi = document.getElementById('fileInput');
uz.addEventListener('dragover', e => { e.preventDefault(); uz.classList.add('drag-over'); });
uz.addEventListener('dragleave', () => uz.classList.remove('drag-over'));
uz.addEventListener('drop', e => { e.preventDefault(); uz.classList.remove('drag-over'); handleFiles(e.dataTransfer.files); });
fi.addEventListener('change', e => { handleFiles(e.target.files); fi.value = ''; });

async function handleFiles(files) {
  for(const f of files) {
    const id = Date.now() + '-' + Math.random().toString(36).slice(2);

    if(f.type === 'application/pdf') {
      await uploadPDF(f, id);
    } else if(f.type.startsWith('image/')) {
      // ImÃ¡genes: enviar al servidor para OCR con Groq Vision
      await uploadImage(f, id);
    } else {
      // TXT u otro texto
      await uploadText(f, id);
    }
  }
}

async function uploadPDF(file, id) {
  toast(`â³ Convirtiendo pÃ¡ginas de ${file.name}...`);
  setProgress(5, 'Cargando PDF...');
  try {
    // 1) Cargar pdf.js desde CDN
    if (!window.pdfjsLib) {
      await new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
        s.onload = resolve; s.onerror = reject;
        document.head.appendChild(s);
      });
      window.pdfjsLib.GlobalWorkerOptions.workerSrc =
        'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }

    // 2) Leer el archivo como ArrayBuffer
    const arrayBuffer = await file.arrayBuffer();
    const pdf = await window.pdfjsLib.getDocument({ data: arrayBuffer }).promise;
    const totalPages = Math.min(pdf.numPages, 9);
    const pages = [];

    // 3) Renderizar cada pÃ¡gina a canvas â†’ JPEG base64
    for (let i = 1; i <= totalPages; i++) {
      setProgress(Math.round(5 + (i / totalPages) * 50),
        `Renderizando pÃ¡gina ${i}/${totalPages}...`);

      const page = await pdf.getPage(i);

      // Intentar texto digital primero (PDF no escaneado)
      const tc = await page.getTextContent();
      const txt = tc.items.map(it => it.str).join(' ').trim();
      if (txt.length > 80) {
        pages.push({ type: 'text', content: txt, pageNum: i });
        continue;
      }

      // Escaneado â†’ renderizar a imagen
      const viewport = page.getViewport({ scale: 1.8 });
      const canvas = document.createElement('canvas');
      canvas.width  = viewport.width;
      canvas.height = viewport.height;
      await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
      // Convertir a JPEG para reducir tamaÃ±o
      const base64 = canvas.toDataURL('image/jpeg', 0.85).split(',')[1];
      pages.push({ base64, mime: 'image/jpeg', pageNum: i });
    }

    setProgress(60, 'Enviando a Groq Vision para OCR...');

    // 4) Mandar todas las pÃ¡ginas al servidor
    const res = await fetch('/api/upload-pages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ pages, filename: file.name })
    });
    setProgress(90, 'Generando resumen...');
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || `Error ${res.status}`);

    setProgress(100, 'Â¡Listo!');
    setTimeout(() => setProgress(null), 1000);

    S.apuntes.push({ id, name: file.name, type: 'pdf', chars: data.charCount });
    saveApuntes(); renderApuntesList();
    appendResumen(data.resumen);
    toast(`âœ… ${file.name} procesado (${totalPages} pÃ¡ginas, OCR automÃ¡tico)`, 'ok', 6000);

  } catch(err) {
    setProgress(null);
    const msg = err.message || 'Error desconocido';
    document.getElementById('apuntesResumen').innerHTML +=
      `<div class="err-box">âŒ Error con "${file.name}": ${msg}</div>`;
    toast(`âŒ ${msg}`, 'warn', 8000);
    console.error('uploadPDF error:', err);
  }
}

async function uploadImage(file, id) {
  setProgress(10, `Enviando imagen ${file.name} para OCR...`);
  toast(`ğŸ” Leyendo imagen con IA: ${file.name}...`);
  try {
    const formData = new FormData();
    formData.append('file', file);
    setProgress(40, 'Groq Vision leyendo el texto de la imagen...');
    const res = await fetch('/api/upload-image', { method: 'POST', body: formData });
    setProgress(80, 'Generando resumen...');
    const data = await res.json();
    if(!res.ok) throw new Error(data.error || `Error ${res.status}`);
    setProgress(100, 'Â¡Listo!');
    setTimeout(() => setProgress(null), 800);
    // Preview visual
    const url = await readAsDataURL(file);
    S.apuntes.push({ id, name: file.name, type: 'image', url, chars: data.charCount });
    saveApuntes(); renderApuntesList();
    appendResumen(data.resumen);
    toast(`âœ… Imagen procesada con OCR: ${file.name}`, 'ok', 5000);
  } catch(err) {
    setProgress(null);
    document.getElementById('apuntesResumen').innerHTML += `<div class="err-box">âŒ Error OCR "${file.name}": ${err.message}</div>`;
    toast(`âŒ ${err.message}`, 'warn', 7000);
  }
}

async function uploadText(file, id) {
  try {
    setProgress(20, `Leyendo ${file.name}...`);
    const text = await readAsText(file);
    setProgress(50, 'Enviando a Groq...');

    const res = await fetch('/api/analyze-text', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text, name: file.name })
    });
    const data = await res.json();
    if(!res.ok) throw new Error(data.error || `Error ${res.status}`);

    setProgress(100, 'Â¡Listo!');
    setTimeout(() => setProgress(null), 800);

    S.apuntes.push({ id, name: file.name, type: 'text', chars: text.length });
    saveApuntes();
    renderApuntesList();
    appendResumen(data.resumen);
    toast(`âœ… Texto procesado: ${file.name}`, 'ok');

  } catch(err) {
    setProgress(null);
    toast(`âŒ ${err.message}`, 'warn', 6000);
  }
}

function appendResumen(html) {
  if(!html) return;
  S.resumen = S.resumen
    ? S.resumen + '<hr style="border:none;border-top:1px solid var(--border);margin:1rem 0">' + html
    : html;
  localStorage.setItem('pc_resumen', S.resumen);
  document.getElementById('apuntesResumen').innerHTML = `<div style="line-height:1.8">${S.resumen}</div>`;
  extractDrugsFromResumen(html);
}

function extractDrugsFromResumen(html) {
  // Extraer nombres de fÃ¡rmacos de las etiquetas <strong> dentro de listas de medicamentos
  const tmp = document.createElement('div');
  tmp.innerHTML = html;
  const strongs = tmp.querySelectorAll('ul li strong');
  const nuevos = [];
  strongs.forEach(el => {
    const name = el.textContent.trim();
    if (name && name.length > 2 && name.length < 40 && !S.extractedDrugs.includes(name)) {
      nuevos.push(name);
    }
  });
  S.extractedDrugs.push(...nuevos);
  // Actualizar el botÃ³n del quiz si existe
  updateQuizDrugsBtn();
}

function updateQuizDrugsBtn() {
  const btn = document.getElementById('usarMedicamentosBtn');
  if (!btn) return;
  if (S.extractedDrugs.length > 0) {
    btn.style.display = 'inline-flex';
    btn.title = S.extractedDrugs.join(', ');
  } else {
    btn.style.display = 'none';
  }
}

function saveApuntes() {
  try {
    localStorage.setItem('pc_apuntes', JSON.stringify(
      S.apuntes.map(a => ({ id:a.id, name:a.name, type:a.type, chars:a.chars, url: a.url ? '[img]' : undefined }))
    ));
  } catch(e) {}
}

function renderApuntesList() {
  const l = document.getElementById('apuntesList');
  l.innerHTML = S.apuntes.map(a => `
    <div class="apunte-tag">
      ${a.type==='image' && a.url ? `<img src="${a.url}" class="apunte-thumb" alt="">` : a.type==='pdf' ? 'ğŸ“•' : 'ğŸ“„'}
      <span>${a.name}${a.chars ? ` Â· ${(a.chars/1000).toFixed(1)}k` : ''}</span>
      <button class="rm" onclick="removeApunte('${a.id}')">âœ•</button>
    </div>`).join('');
}

function removeApunte(id) {
  S.apuntes = S.apuntes.filter(a => a.id !== id);
  saveApuntes(); renderApuntesList();
  toast('ğŸ—‘ Apunte eliminado');
}

async function clearAll() {
  S.apuntes = []; S.resumen = '';
  localStorage.removeItem('pc_apuntes'); localStorage.removeItem('pc_resumen');
  renderApuntesList();
  document.getElementById('apuntesResumen').innerHTML = '<div class="empty"><div class="emoji">ğŸ“‚</div><p>Apuntes limpiados</p></div>';
  try { await fetch('/api/clear-notes', { method:'POST' }); } catch(e) {}
  toast('ğŸ—‘ Todo limpiado');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FLASHCARDS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function searchDrug() {
  const drug = document.getElementById('drugInput').value.trim();
  if(!drug) { toast('âš  Escribe el nombre de un medicamento'); return; }

  if(!S.history.includes(drug)) {
    S.history.unshift(drug);
    S.history = S.history.slice(0, 10);
    localStorage.setItem('pc_history', JSON.stringify(S.history));
    renderHistory();
  }

  document.getElementById('flashLoader').classList.add('active');
  document.getElementById('flashcardsContainer').innerHTML = '';

  try {
    const res = await fetch('/api/flashcards', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ drug })
    });
    const data = await res.json();
    if(!res.ok) throw new Error(data.error || `Error ${res.status}`);
    renderFlashcards(data);
  } catch(err) {
    document.getElementById('flashcardsContainer').innerHTML = `
      <div class="empty">
        <div class="emoji">âŒ</div>
        <div class="err-box">${err.message}</div>
        <p style="margin-top:1rem;font-size:.85rem">Verifica que el servidor estÃ© corriendo: <strong>npm start</strong></p>
      </div>`;
    toast('âŒ ' + err.message, 'warn', 6000);
  } finally {
    document.getElementById('flashLoader').classList.remove('active');
  }
}

function renderFlashcards(data) {
  const cm = { teal:'#4fc3c3', purple:'#7c6fd4', gold:'#c9a84c', red:'#ef5350' };
  S.currentFlashcardData = data;

  document.getElementById('flashcardsContainer').innerHTML = `
    <div style="display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:1rem;margin-bottom:1.5rem">
      <div>
        <h2 style="font-family:'Playfair Display',serif;font-size:1.9rem;margin-bottom:.2rem">${data.nombre || 'Medicamento'}</h2>
        <span style="font-family:'DM Mono',monospace;font-size:.75rem;color:var(--text-dim)">${data.familia || ''}</span>
      </div>
      <div>
        <button class="btn btn-secondary" onclick="downloadFlashcardsImage()" title="Descargar como imagen">
          ğŸ–¼ Descargar Imagen
        </button>
      </div>
    </div>
    <div class="flashcards-grid" id="flashcardsGrid">
      ${(data.cards || []).map((c, i) => {
        const col = cm[c.color] || cm.teal;
        return `<div class="flashcard" id="fc-${i}" style="animation-delay:${i*.06}s;border-top:2px solid ${col}50;position:relative">
          <button onclick="openEditModal(${i})" title="Editar" style="
            position:absolute;top:10px;right:10px;
            background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);
            border-radius:7px;color:var(--text-dim);font-size:.75rem;
            padding:.3rem .6rem;cursor:pointer;transition:all .2s;z-index:2;
            font-family:'DM Mono',monospace;
          " onmouseover="this.style.color='var(--accent)';this.style.borderColor='var(--accent)'"
             onmouseout="this.style.color='var(--text-dim)';this.style.borderColor='rgba(255,255,255,0.12)'">
            âœï¸ Editar
          </button>
          <div class="fc-header">
            <div class="fc-icon" style="background:${col}20;color:${col}">${c.icono}</div>
            <div class="fc-title" style="color:${col}">${c.titulo}</div>
          </div>
          <div class="fc-body" id="fc-body-${i}">
            <div id="fc-content-${i}">${c.contenido}</div>
            ${c.enApuntes && c.notaApuntes ? `
              <div class="apuntes-note-box" id="fc-nota-box-${i}">
                <div class="apuntes-note-label">ğŸ“ EN TUS APUNTES</div>
                <div id="fc-nota-${i}" style="font-size:.88rem">${c.notaApuntes}</div>
              </div>` : `<div id="fc-nota-box-${i}" style="display:none">
                <div class="apuntes-note-box">
                  <div class="apuntes-note-label">ğŸ“ EN TUS APUNTES</div>
                  <div id="fc-nota-${i}" style="font-size:.88rem"></div>
                </div>
              </div>`}
            <div style="margin-top:.75rem">
              <span class="badge badge-ai">ğŸ¤– Groq Â· Llama 4</span>
              ${c.enApuntes ? '<span class="badge badge-notes" style="margin-left:.3rem">ğŸ“ Apuntes</span>' : ''}
            </div>
          </div>
        </div>`;
      }).join('')}
    </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODAL DE EDICIÃ“N
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openEditModal(cardIndex) {
  const data = S.currentFlashcardData;
  if (!data?.cards?.[cardIndex]) return;
  const card = data.cards[cardIndex];
  const cm = { teal:'#4fc3c3', purple:'#7c6fd4', gold:'#c9a84c', red:'#ef5350' };
  const col = cm[card.color] || cm.teal;

  // Crear modal si no existe
  let modal = document.getElementById('editModal');
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'editModal';
    modal.style.cssText = `
      position:fixed;inset:0;z-index:9999;display:flex;align-items:center;justify-content:center;
      background:rgba(0,0,0,0.75);backdrop-filter:blur(6px);padding:1rem;
    `;
    document.body.appendChild(modal);
  }

  modal.innerHTML = `
    <div style="
      background:#0d1020;border:1px solid #1e2545;border-radius:18px;
      width:100%;max-width:620px;max-height:90vh;overflow-y:auto;
      box-shadow:0 20px 60px rgba(0,0,0,0.6);
    ">
      <!-- Header -->
      <div style="padding:1.4rem 1.6rem;border-bottom:1px solid #1e2545;display:flex;align-items:center;justify-content:space-between">
        <div style="display:flex;align-items:center;gap:.75rem">
          <div style="width:10px;height:10px;border-radius:50%;background:${col}"></div>
          <span style="font-family:'DM Mono',monospace;font-size:.8rem;color:${col};text-transform:uppercase;letter-spacing:.1em">${card.titulo}</span>
        </div>
        <button onclick="closeEditModal()" style="background:none;border:none;color:var(--text-dim);font-size:1.3rem;cursor:pointer;padding:.2rem .5rem;border-radius:6px"
          onmouseover="this.style.color='var(--danger)'" onmouseout="this.style.color='var(--text-dim)'">âœ•</button>
      </div>

      <!-- Body -->
      <div style="padding:1.6rem;display:flex;flex-direction:column;gap:1.2rem">

        <div>
          <label style="font-family:'DM Mono',monospace;font-size:.72rem;color:var(--text-dim);letter-spacing:.08em;text-transform:uppercase;display:block;margin-bottom:.5rem">
            ğŸ“‹ Contenido principal
          </label>
          <textarea id="editContenido" rows="7" style="
            width:100%;background:#07080f;border:1px solid #1e2545;border-radius:10px;
            color:var(--text);font-family:'Crimson Pro',serif;font-size:1rem;
            padding:.9rem 1rem;resize:vertical;line-height:1.6;outline:none;
            transition:border-color .2s;
          " onfocus="this.style.borderColor='${col}'" onblur="this.style.borderColor='#1e2545'"
          >${card.contenido}</textarea>
        </div>

        <div>
          <label style="font-family:'DM Mono',monospace;font-size:.72rem;color:#c9a84c;letter-spacing:.08em;text-transform:uppercase;display:block;margin-bottom:.5rem">
            ğŸ“ Nota de tus apuntes <span style="color:var(--text-dim);font-size:.65rem">(opcional)</span>
          </label>
          <textarea id="editNota" rows="4" placeholder="Escribe aquÃ­ informaciÃ³n adicional de tus apuntes..." style="
            width:100%;background:#1a130a;border:1px solid #3a2a10;border-radius:10px;
            color:#c9a84c;font-family:'Crimson Pro',serif;font-size:.95rem;
            padding:.9rem 1rem;resize:vertical;line-height:1.6;outline:none;
            transition:border-color .2s;
          " onfocus="this.style.borderColor='#c9a84c'" onblur="this.style.borderColor='#3a2a10'"
          >${card.notaApuntes || ''}</textarea>
        </div>

        <div style="display:flex;gap:.75rem;justify-content:flex-end;padding-top:.5rem">
          <button onclick="closeEditModal()" class="btn btn-secondary">Cancelar</button>
          <button onclick="saveCardEdit(${cardIndex})" class="btn btn-primary">ğŸ’¾ Guardar cambios</button>
        </div>
      </div>
    </div>
  `;

  modal.style.display = 'flex';
  // Cerrar al hacer click fuera
  modal.addEventListener('click', function(e) {
    if (e.target === modal) closeEditModal();
  }, { once: true });

  // Focus en el textarea
  setTimeout(() => document.getElementById('editContenido')?.focus(), 100);
}

function closeEditModal() {
  const modal = document.getElementById('editModal');
  if (modal) modal.style.display = 'none';
}

function saveCardEdit(cardIndex) {
  const data = S.currentFlashcardData;
  if (!data?.cards?.[cardIndex]) return;

  const nuevoContenido = document.getElementById('editContenido').value.trim();
  const nuevaNota      = document.getElementById('editNota').value.trim();

  if (!nuevoContenido) { toast('âš  El contenido no puede estar vacÃ­o', 'warn'); return; }

  // Actualizar en memoria
  data.cards[cardIndex].contenido   = nuevoContenido;
  data.cards[cardIndex].notaApuntes = nuevaNota;
  data.cards[cardIndex].enApuntes   = nuevaNota.length > 0;

  // Actualizar DOM sin re-renderizar todo
  const contentEl  = document.getElementById(`fc-content-${cardIndex}`);
  const notaEl     = document.getElementById(`fc-nota-${cardIndex}`);
  const notaBoxEl  = document.getElementById(`fc-nota-box-${cardIndex}`);

  if (contentEl) contentEl.textContent = nuevoContenido;
  if (notaEl)    notaEl.textContent    = nuevaNota;
  if (notaBoxEl) notaBoxEl.style.display = nuevaNota ? 'block' : 'none';

  closeEditModal();
  toast('âœ… Flashcard actualizada', 'ok');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS COMPARTIDOS PARA DESCARGA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function loadScript(src) {
  return new Promise((resolve, reject) => {
    if (document.querySelector(`script[src="${src}"]`)) { resolve(); return; }
    const s = document.createElement('script');
    s.src = src; s.onload = resolve; s.onerror = reject;
    document.head.appendChild(s);
  });
}

// Colores por categorÃ­a (sin emojis)
const CARD_COLORS = {
  teal:   { r:79,  g:195, b:195 },
  purple: { r:124, g:111, b:212 },
  gold:   { r:201, g:168, b:76  },
  red:    { r:239, g:83,  b:80  }
};

const CARD_LABELS = {
  'Mecanismo de AcciÃ³n':       'MECANISMO',
  'Espectro / ClasificaciÃ³n':  'ESPECTRO',
  'Indicaciones ClÃ­nicas':     'INDICACIONES',
  'Contraindicaciones':        'CONTRAINDICACIONES',
  'Interacciones FarmacolÃ³gicas': 'INTERACCIONES',
  'Reacciones Adversas (RAM)': 'RAM',
  'FarmacocinÃ©tica (ADME)':    'FARMACOCINÃ‰TICA',
  'Dosis y Presentaciones':    'DOSIS'
};


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FUNCIÃ“N COMPARTIDA: construye el canvas con las flashcards
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function buildFlashcardsCanvas(data) {
  const cards = data.cards || [];
  const SCALE = 2;
  const M = 40 * SCALE;
  const GAP = 16 * SCALE;
  const COLS = 2;
  const CW = 380 * SCALE;
  const TOTAL_W = M * 2 + CW * COLS + GAP;
  const HEADER_H = 100 * SCALE;
  const CARD_PAD = 20 * SCALE;
  const FONT_TITLE = 11 * SCALE;
  const FONT_BODY  = 9.5 * SCALE;
  const LINE_H = 14 * SCALE;

  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');

  ctx.font = `${FONT_BODY}px -apple-system, Segoe UI, sans-serif`;
  function wrapText(text, maxW) {
    const words = (text || '').split(' ');
    const lines = []; let line = '';
    for (const w of words) {
      const test = line ? line + ' ' + w : w;
      if (ctx.measureText(test).width > maxW) { lines.push(line); line = w; }
      else line = test;
    }
    if (line) lines.push(line);
    return lines;
  }

  const cardMetas = cards.map(card => {
    const bodyLines = wrapText(card.contenido || '', CW - CARD_PAD * 2);
    const notaLines = card.enApuntes && card.notaApuntes
      ? wrapText('Tus apuntes: ' + card.notaApuntes, CW - CARD_PAD * 2 - 12 * SCALE)
      : [];
    const TITLE_H = 48 * SCALE;
    const BODY_H  = bodyLines.length * LINE_H + CARD_PAD;
    const NOTA_H  = notaLines.length > 0 ? notaLines.length * (LINE_H * 0.9) + 28 * SCALE : 0;
    const totalH  = TITLE_H + BODY_H + NOTA_H + CARD_PAD;
    return { card, bodyLines, notaLines, totalH };
  });

  // Calcular alturas por fila (cada fila usa la tarjeta mÃ¡s alta)
  const rowHeights = [];
  for (let i = 0; i < cardMetas.length; i += COLS) {
    const pair = cardMetas.slice(i, i + COLS);
    rowHeights.push(Math.max(...pair.map(m => m.totalH)));
  }

  let totalH = HEADER_H + GAP;
  for (const rh of rowHeights) totalH += rh + GAP;
  totalH += M;

  canvas.width  = TOTAL_W;
  canvas.height = totalH;

  // FONDO
  ctx.fillStyle = '#07080f';
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  // ENCABEZADO
  ctx.fillStyle = '#0d1020';
  ctx.fillRect(0, 0, canvas.width, HEADER_H);
  const grad = ctx.createLinearGradient(M, 0, M + 300 * SCALE, 0);
  grad.addColorStop(0, '#4fc3c3');
  grad.addColorStop(1, '#7c6fd4');
  ctx.fillStyle = grad;
  ctx.fillRect(M, HEADER_H - 3, 300 * SCALE, 3);
  ctx.fillStyle = '#4fc3c3';
  ctx.font = `bold ${28 * SCALE}px Georgia, serif`;
  ctx.fillText(data.nombre || 'Medicamento', M, 38 * SCALE);
  ctx.fillStyle = '#8892b0';
  ctx.font = `${11 * SCALE}px -apple-system, Segoe UI, sans-serif`;
  ctx.fillText(data.familia || '', M, 58 * SCALE);
  ctx.fillStyle = '#3a4560';
  ctx.font = `${9 * SCALE}px monospace`;
  ctx.fillText('PharmaChem  Â·  Groq + Llama 4', M, 78 * SCALE);

  const COLORS = { teal:'#4fc3c3', purple:'#7c6fd4', gold:'#c9a84c', red:'#ef5350' };

  function roundRect(x, y, w, h, r) {
    ctx.beginPath();
    ctx.moveTo(x+r,y); ctx.lineTo(x+w-r,y);
    ctx.quadraticCurveTo(x+w,y,x+w,y+r);
    ctx.lineTo(x+w,y+h-r);
    ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
    ctx.lineTo(x+r,y+h);
    ctx.quadraticCurveTo(x,y+h,x,y+h-r);
    ctx.lineTo(x,y+r);
    ctx.quadraticCurveTo(x,y,x+r,y);
    ctx.closePath();
  }

  let cardY = HEADER_H + GAP;

  for (let row = 0; row < rowHeights.length; row++) {
    const rowH = rowHeights[row];
    for (let col = 0; col < COLS; col++) {
      const idx = row * COLS + col;
      if (idx >= cardMetas.length) break;
      const { card, bodyLines, notaLines } = cardMetas[idx];
      const color = COLORS[card.color] || COLORS.teal;
      const cx = M + col * (CW + GAP);

      // Sombra
      ctx.shadowColor = 'rgba(0,0,0,0.5)';
      ctx.shadowBlur = 15 * SCALE;
      ctx.shadowOffsetY = 4 * SCALE;
      ctx.fillStyle = '#131628';
      roundRect(cx, cardY, CW, rowH, 10 * SCALE);
      ctx.fill();
      ctx.shadowColor = 'transparent'; ctx.shadowBlur = 0;

      // Borde color arriba
      ctx.fillStyle = color;
      roundRect(cx, cardY, CW, 5 * SCALE, 3 * SCALE);
      ctx.fill();
      ctx.fillRect(cx, cardY + 2*SCALE, CW, 3*SCALE);

      // CÃ­rculo
      ctx.beginPath();
      ctx.arc(cx+28*SCALE, cardY+30*SCALE, 10*SCALE, 0, Math.PI*2);
      ctx.fillStyle = color+'33'; ctx.fill();
      ctx.beginPath();
      ctx.arc(cx+28*SCALE, cardY+30*SCALE, 5*SCALE, 0, Math.PI*2);
      ctx.fillStyle = color; ctx.fill();

      // TÃ­tulo
      ctx.fillStyle = color;
      ctx.font = `bold ${FONT_TITLE}px -apple-system, Segoe UI, sans-serif`;
      const label = CARD_LABELS[card.titulo] || card.titulo.toUpperCase();
      ctx.fillText(label, cx+46*SCALE, cardY+35*SCALE);

      // Separador
      ctx.strokeStyle = color+'44'; ctx.lineWidth = 1*SCALE;
      ctx.beginPath();
      ctx.moveTo(cx+CARD_PAD, cardY+48*SCALE);
      ctx.lineTo(cx+CW-CARD_PAD, cardY+48*SCALE);
      ctx.stroke();

      // Texto
      ctx.fillStyle = '#c8d5f0';
      ctx.font = `${FONT_BODY}px -apple-system, Segoe UI, sans-serif`;
      let textY = cardY + 64*SCALE;
      for (const line of bodyLines) { ctx.fillText(line, cx+CARD_PAD, textY); textY += LINE_H; }

      // Nota apuntes
      if (notaLines.length > 0) {
        const notaY = textY + 8*SCALE;
        const notaH = notaLines.length*(LINE_H*0.9) + 20*SCALE;
        ctx.fillStyle = '#281f08';
        roundRect(cx+CARD_PAD, notaY, CW-CARD_PAD*2, notaH, 5*SCALE); ctx.fill();
        ctx.fillStyle = '#c9a84c';
        ctx.fillRect(cx+CARD_PAD, notaY, 4*SCALE, notaH);
        ctx.fillStyle = '#c9a84c';
        ctx.font = `${8.5*SCALE}px -apple-system, Segoe UI, sans-serif`;
        let ny = notaY + 14*SCALE;
        for (const nl of notaLines) { ctx.fillText(nl, cx+CARD_PAD+12*SCALE, ny); ny += LINE_H*0.9; }
      }
    }
    cardY += rowH + GAP;
  }

  return canvas;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DESCARGAR IMAGEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function downloadFlashcardsImage() {
  const data = S.currentFlashcardData;
  if (!data?.cards?.length) { toast('âš  No hay flashcards para descargar', 'warn'); return; }
  toast('â³ Generando imagen...', 'normal', 8000);
  const canvas = await buildFlashcardsCanvas(data);
  const link = document.createElement('a');
  link.download = `${(data.nombre || 'flashcards').replace(/\s+/g,'_')}_farmacologia.png`;
  link.href = canvas.toDataURL('image/png');
  link.click();
  toast('âœ… Imagen descargada', 'ok');
}

function usarMedicamentosDelResumen() {
  if (!S.extractedDrugs.length) { toast('âš  Sube un archivo primero para extraer medicamentos', 'warn'); return; }
  document.getElementById('quizDrugs').value = S.extractedDrugs.slice(0, 10).join(', ');
  toast(`âœ… ${S.extractedDrugs.length} medicamentos cargados del resumen`, 'ok');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODO REPASO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const REPASO = { cards: [], current: 0, revealed: false, sabidas: 0, noSabidas: 0 };

function iniciarRepaso() {
  const data = S.currentFlashcardData;
  const el = document.getElementById('repasoContainer');

  if (!data?.cards?.length) {
    el.innerHTML = `
      <div class="empty">
        <div class="emoji">ğŸƒ</div>
        <p>Primero genera flashcards de un medicamento,<br>luego vuelve aquÃ­ para repasar</p>
        <button class="btn btn-primary" onclick="showPage('flashcards',document.querySelectorAll('.nav-btn')[1])" style="margin-top:1rem">Ir a Flashcards</button>
      </div>`;
    return;
  }

  // Mezclar las cards
  REPASO.cards = [...data.cards].sort(() => Math.random() - 0.5);
  REPASO.current = 0;
  REPASO.revealed = false;
  REPASO.sabidas = 0;
  REPASO.noSabidas = 0;
  renderRepasoCard();
}

function renderRepasoCard() {
  const el = document.getElementById('repasoContainer');
  const total = REPASO.cards.length;
  const idx   = REPASO.current;

  if (idx >= total) {
    // Resultados finales
    const pct = Math.round(REPASO.sabidas / total * 100);
    const emoji = pct >= 80 ? 'ğŸ†' : pct >= 60 ? 'âœ…' : 'ğŸ“–';
    el.innerHTML = `
      <div style="max-width:500px;margin:0 auto;text-align:center">
        <div style="font-size:4rem;margin-bottom:1rem">${emoji}</div>
        <h2 style="font-family:'Playfair Display',serif;font-size:2rem;margin-bottom:.5rem;color:var(--accent)">${pct}% dominado</h2>
        <p style="color:var(--text-dim);margin-bottom:2rem">de ${total} cards â€” ${REPASO.sabidas} sabidas, ${REPASO.noSabidas} para repasar</p>
        <div style="display:flex;gap:1rem;justify-content:center;flex-wrap:wrap">
          <button class="btn btn-primary" onclick="iniciarRepaso()">ğŸ”„ Repasar de nuevo</button>
          <button class="btn btn-secondary" onclick="repasoSoloFalladas()">âŒ Solo las que fallÃ©</button>
        </div>
      </div>`;
    return;
  }

  const card = REPASO.cards[idx];
  const cm = { teal:'#4fc3c3', purple:'#7c6fd4', gold:'#c9a84c', red:'#ef5350' };
  const col = cm[card.color] || cm.teal;
  const data = S.currentFlashcardData;

  el.innerHTML = `
    <div style="max-width:640px;margin:0 auto">

      <!-- Progreso -->
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1.2rem;flex-wrap:wrap;gap:.5rem">
        <span style="font-family:'DM Mono',monospace;font-size:.75rem;color:var(--text-dim)">${data.nombre} Â· Card ${idx+1} de ${total}</span>
        <div style="display:flex;gap:.5rem">
          <span style="font-family:'DM Mono',monospace;font-size:.72rem;padding:.2rem .6rem;background:rgba(38,166,154,.15);color:var(--success);border-radius:6px">âœ“ ${REPASO.sabidas}</span>
          <span style="font-family:'DM Mono',monospace;font-size:.72rem;padding:.2rem .6rem;background:rgba(239,83,80,.15);color:var(--danger);border-radius:6px">âœ— ${REPASO.noSabidas}</span>
        </div>
      </div>

      <!-- Barra de progreso -->
      <div style="height:4px;background:#1e2545;border-radius:4px;margin-bottom:1.5rem;overflow:hidden">
        <div style="height:100%;width:${(idx/total)*100}%;background:linear-gradient(90deg,var(--accent),var(--accent3));transition:width .4s"></div>
      </div>

      <!-- Card -->
      <div style="background:#131628;border:1px solid #1e2545;border-radius:18px;overflow:hidden;box-shadow:0 8px 32px rgba(0,0,0,0.4)">

        <!-- Titulo (siempre visible) -->
        <div style="padding:1.4rem 1.6rem;border-bottom:1px solid #1e2545;display:flex;align-items:center;gap:.75rem;background:#0d1020">
          <div style="width:12px;height:12px;border-radius:50%;background:${col};flex-shrink:0"></div>
          <span style="font-family:'DM Mono',monospace;font-size:.8rem;color:${col};text-transform:uppercase;letter-spacing:.1em;font-weight:600">${card.titulo}</span>
        </div>

        <!-- Pregunta / Hint -->
        <div style="padding:2rem 1.6rem;text-align:center;min-height:80px;display:flex;align-items:center;justify-content:center">
          <p style="color:var(--text-dim);font-size:1rem;font-style:italic">Â¿CuÃ¡l es el <strong style="color:${col}">${card.titulo.toLowerCase()}</strong> de <strong style="color:var(--text)">${data.nombre}</strong>?</p>
        </div>

        <!-- Respuesta (oculta hasta revelar) -->
        <div id="repasoRespuesta" style="border-top:1px solid #1e2545;padding:1.4rem 1.6rem;display:${REPASO.revealed ? 'block' : 'none'}">
          <p style="line-height:1.7;color:var(--text)">${card.contenido}</p>
          ${card.enApuntes && card.notaApuntes ? `
            <div style="margin-top:1rem;padding:.8rem 1rem;background:#1a130a;border-left:3px solid #c9a84c;border-radius:0 8px 8px 0">
              <div style="font-family:'DM Mono',monospace;font-size:.65rem;color:#c9a84c;margin-bottom:.3rem">ğŸ“ TUS APUNTES</div>
              <p style="font-size:.9rem;color:#c9a84c">${card.notaApuntes}</p>
            </div>` : ''}
        </div>

        <!-- Botones -->
        <div style="padding:1.2rem 1.6rem;border-top:1px solid #1e2545;display:flex;gap:.75rem;justify-content:center;flex-wrap:wrap">
          ${!REPASO.revealed ? `
            <button class="btn btn-primary" onclick="revelarRepaso()" style="min-width:180px">
              ğŸ‘ Ver respuesta
            </button>
          ` : `
            <button class="btn btn-secondary" onclick="marcarRepaso(false)"
              style="border-color:var(--danger);color:var(--danger);min-width:140px"
              onmouseover="this.style.background='rgba(239,83,80,.1)'" onmouseout="this.style.background='transparent'">
              âœ— No lo sabÃ­a
            </button>
            <button class="btn btn-secondary" onclick="marcarRepaso(true)"
              style="border-color:var(--success);color:var(--success);min-width:140px"
              onmouseover="this.style.background='rgba(38,166,154,.1)'" onmouseout="this.style.background='transparent'">
              âœ“ Lo sabÃ­a
            </button>
          `}
        </div>
      </div>
    </div>`;
}

function revelarRepaso() {
  REPASO.revealed = true;
  document.getElementById('repasoRespuesta').style.display = 'block';
  // Cambiar botÃ³n
  renderRepasoCard();
}

function marcarRepaso(sabia) {
  if (sabia) REPASO.sabidas++;
  else { REPASO.noSabidas++; REPASO.cards.push(REPASO.cards[REPASO.current]); } // re-aÃ±adir al final si fallÃ³
  REPASO.current++;
  REPASO.revealed = false;
  // Limitar mÃ¡ximo a 3 vueltas para evitar loop infinito
  if (REPASO.cards.length > S.currentFlashcardData.cards.length * 3) {
    REPASO.current = REPASO.cards.length; // forzar fin
  }
  renderRepasoCard();
}

function repasoSoloFalladas() {
  // Repasar solo las que se marcaron como no sabidas
  const falladas = REPASO.cards.slice(S.currentFlashcardData.cards.length);
  if (!falladas.length) { toast('Â¡No fallaste ninguna! ğŸ†', 'ok'); return; }
  REPASO.cards = [...new Set(falladas)]; // deduplicar
  REPASO.current = 0; REPASO.revealed = false;
  REPASO.sabidas = 0; REPASO.noSabidas = 0;
  renderRepasoCard();
}

function renderHistory() {
  document.getElementById('drugHistory').innerHTML = S.history.map(d =>
    `<span class="drug-pill" onclick="document.getElementById('drugInput').value='${d}';searchDrug()">${d}</span>`
  ).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// QUIZ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function generateQuiz() {
  const drugs = document.getElementById('quizDrugs').value.trim();
  const count = parseInt(document.getElementById('quizCount').value) || 10;
  const difficulty = document.getElementById('quizDiff').value;
  const type = document.getElementById('quizType').value;
  if(!drugs) { toast('âš  Escribe al menos un medicamento'); return; }

  document.getElementById('quizLoader').classList.add('active');
  document.getElementById('quizContainer').innerHTML = '';
  S.answers = {}; S.submitted = false;

  try {
    const res = await fetch('/api/quiz', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ drugs, count, difficulty, type })
    });
    const data = await res.json();
    if(!res.ok) throw new Error(data.error || `Error ${res.status}`);
    S.quiz = Array.isArray(data) ? data : [];
    if(!S.quiz.length) throw new Error('No se generaron preguntas. Intenta de nuevo.');
    renderQuiz(S.quiz);
  } catch(err) {
    document.getElementById('quizContainer').innerHTML = `<div class="empty"><div class="emoji">âŒ</div><div class="err-box">${err.message}</div></div>`;
    toast('âŒ ' + err.message, 'warn', 6000);
  } finally {
    document.getElementById('quizLoader').classList.remove('active');
  }
}

function renderQuiz(qs) {
  const L = ['A','B','C','D'];
  let html = qs.map((q, qi) => `
    <div class="question-card" style="animation-delay:${qi*.04}s">
      <div class="q-num">Pregunta ${qi+1} de ${qs.length}</div>
      <div class="q-text">${q.pregunta}</div>
      <div class="q-src">ğŸ“š ${q.fuente}</div>
      <div class="options" id="opts-${qi}">
        ${(q.opciones||[]).map((o,oi) => `
          <div class="opt" onclick="selectOpt(${qi},${oi})">
            <div class="opt-letter">${L[oi]}</div>
            <div class="opt-text">${o}</div>
          </div>`).join('')}
      </div>
      <div class="expl" id="exp-${qi}">${q.explicacion || ''}</div>
    </div>`).join('');

  html += `
    <div style="display:flex;gap:1rem;margin-top:1rem;flex-wrap:wrap">
      <button class="btn btn-primary" onclick="submitQuiz()">âœ… Corregir Quiz</button>
      <button class="btn btn-secondary" onclick="generateQuiz()">ğŸ”„ Nuevo Quiz</button>
    </div>
    <div id="quizResult"></div>`;

  document.getElementById('quizContainer').innerHTML = html;
}

function selectOpt(qi, oi) {
  if(S.submitted) return;
  S.answers[qi] = oi;
  document.querySelectorAll(`#opts-${qi} .opt`).forEach((el,i) => el.classList.toggle('selected', i===oi));
}

function submitQuiz() {
  if(S.submitted) return;
  const answered = Object.keys(S.answers).length;
  if(answered < S.quiz.length) { toast(`âš  Responde todas (${answered}/${S.quiz.length})`); return; }
  S.submitted = true;
  let correct = 0;

  S.quiz.forEach((q, qi) => {
    const sel = S.answers[qi], ok = sel === q.respuesta;
    if(ok) correct++;
    document.querySelectorAll(`#opts-${qi} .opt`).forEach((el,oi) => {
      el.onclick = null;
      if(oi === q.respuesta) el.classList.add('correct');
      else if(oi === sel && !ok) el.classList.add('wrong');
    });
    document.getElementById(`exp-${qi}`).classList.add('show');
  });

  const tot = S.quiz.length, pct = Math.round(correct/tot*100);
  const g = pct>=90 ? 'ğŸ† Excelente' : pct>=70 ? 'âœ… Muy bien' : pct>=50 ? 'ğŸ“– Regular' : 'ğŸ”„ Necesitas repasar';

  document.getElementById('quizResult').innerHTML = `
    <div class="quiz-results" style="margin-top:2rem">
      <div class="score-ring">${pct}%</div>
      <h2 style="font-family:'Playfair Display',serif;margin-bottom:.5rem">${g}</h2>
      <div class="results-grid">
        <div class="result-stat"><div class="num">${correct}</div><div class="lbl">Correctas</div></div>
        <div class="result-stat"><div class="num">${tot-correct}</div><div class="lbl">Incorrectas</div></div>
        <div class="result-stat"><div class="num">${tot}</div><div class="lbl">Total</div></div>
      </div>
      <button class="btn btn-gold" onclick="generateQuiz()" style="margin-top:1rem">ğŸ”„ Intentar de nuevo</button>
    </div>`;
  document.getElementById('quizResult').scrollIntoView({ behavior:'smooth', block:'center' });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILE READERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const readAsDataURL = f => new Promise(r => { const fr=new FileReader(); fr.onload=e=>r(e.target.result); fr.readAsDataURL(f); });
const readAsText = f => new Promise(r => { const fr=new FileReader(); fr.onload=e=>r(e.target.result); fr.readAsText(f); });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function init() {
  renderApuntesList();
  renderHistory();
  if(S.resumen) {
    document.getElementById('apuntesResumen').innerHTML = `<div style="line-height:1.8">${S.resumen}</div>`;
    extractDrugsFromResumen(S.resumen);
  }
  checkServer();
  setInterval(checkServer, 30000);
})();
</script>
</body>
</html>